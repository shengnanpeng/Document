post:
  summary: コンテンツ受信API
  description: |
    [処理概要]

    コンテンツタイプIDで処理分岐
    - インセンティブコース(10000) ⇒ DB更新（インセンティブコーステーブル、ポップアップ通知テーブル）
    - クーポン(20000） ⇒ DB更新（クーポンテーブル）
    - お知らせ(30000） ⇒ DB更新（お知らせテーブル）
    - コラム(40000） ⇒ キャッシュパージ（単体、画像、カテゴリ別、疾病別）
    - レシピ(50000） ⇒ キャッシュパージ（単体、画像、月別、週別、ランキング、料理別）
    - 動くレシピ(60000) ⇒ キャッシュパージ（単体、画像、カテゴリ別）
    - FAQ(70000) ⇒ キャッシュパージ（単体、画像、配信会社ID別、アプリモード区分ID別、FAQカテゴリ別）
    - ランキング(80000) ⇒ DB更新（ランキング管理テーブル）
    - LCレシピ(90000) ⇒ キャッシュパージ（単体、画像、カテゴリ別）
    - PUSH・ポップアップ(100000) ⇒ 何もしない（MKTアクション受信APIにてDB更新する）

    - DB更新の場合:
      - 処理IDが新規登録の場合、コンテンツ項目でDBに登録を行う。添付画像があればキャッシュを行う
      - 処理IDが改版更新の場合、コンテンツ項目の情報でDBを更新し、論理抹消フラグを有効に更新する。添付画像があればキャッシュを行う
      - 処理IDが公開停止の場合、論理抹消フラグを無効に更新する。

    - キャッシュパージの場合:
      - コンテンツIDをkeyにRedisのキャッシュから現行のコンテンツ情報を取得
      - リクエストのコンテンツ項目の情報とキャッシュから取得したコンテンツ情報の差分からキャッシュパターンを取得
      - キャッシュパターン分繰り返す
        - キャッシュパターン毎にコンテンツ取得APIを呼び出し、コンテンツ情報（一覧情報）を取得する。
        - 取得したコンテンツ情報（一覧情報）のキャッシュを再作成する。

      - 画像キャッシュをパージする場合:
        - 画像URLカラムのパスを利用し、画像ストレージから画像を取得する
        - パスをキャッシュkeyにしてキャッシュを作成する。

    [呼び出し理由]

    ADEP-CMSからキャンペーンの登録または、更新が承認されたため。

    #### エラーメッセージ一覧
    | No | 区分   | エラー条件                   | エラーメッセージ           |
    |----|--------|------------------------------|----------------------------|
    | 1  | global | 登録するインセンティブコース(抽選タイミング=即時抽選)が他の即時抽選のインセンティブコースと期間が重複している場合 | インセンティブコース({contentId})の期間が重複しています |
    | 2  | global | 登録するインセンティブコース(抽選タイミング=月次抽選)が他の月次抽選のインセンティブコースと期間が重複している場合 | インセンティブコース({contentId})の期間が重複しています |
    | 3  | global | 登録するインセンティブコースの期間終了日が期間開始日よりも古い場合 | インセンティブコース({contentId})の期間終了日は期間開始日以降の値を入力してください。 |
    | 4  | global | 登録するクーポンの交換最大数＜抽選券の当選数の場合 | クーポン({contentId})の交換最大数は発行済クーポン数({num})より大きな値を指定してください |
    | 5  | global | 登録するクーポンが週次抽選、または月次抽選のインセンティブコースに紐づく場合で、クーポンの交換最大数が、クーポン配布計画マスタ（定期抽選）のクーポンの掲載期間内の当選本数の総和より小さくなる場合 | クーポン({contentId})の交換最大数は、クーポン配布計画の該当掲載期間内の当選数の総和({{num})よりも大きな値を指定してください |
    | 6  | global | 登録するクーポンの掲載終了日が掲載開始日よりも古い場合 | クーポン({contentId})の掲載終了日は掲載開始日以降の値を入力してください。 |
    | 7  | global | 登録するお知らせの掲載終了日が掲載開始日よりも古い場合 | お知らせ({contentId})の掲載終了日は掲載開始日以降の値を入力してください。 |

    ***
    - v1.0.1 2017/07/11
      - categoryをfaqCategoryに修正
      - contentTypeIdにFAQカテゴリを追加
    - v1.0.2 2018/01/22
      - 有効期限periodStartDateとperiodEndDateを入力requiredに削除
    - v2.0.1 2017/12/25
      - Sprint11に追加
      - 処理概要にLCレシピを追加
      - コンテンツ情報のリクエストパラメータを簡易化
    - v2.0.2 2018/01/08
      - 処理概要にインセンティブコースのDB更新（ポップアップ通知テーブル）を追加
    - v2.0.3 2018/01/24
      - 処理概要にPUSH・ポップアップを追加

  operationId: cmsContentsReceive
  parameters:
    - in: header
      name: Authorization
      description: CMS用の認証トークン。「Bearer+半角スペース」を先頭に付与する。（例：Bearer 97uh3fx86kp4）
      required: true
      type: string
    - in: body
      name: cmsContentsReceiveBody
      description: |
        コンテンツ情報。

        ※全コンテンツで共通のパラメータのみ記載する。他のリクエストパラメータはコンテンツ種別毎に異なるため、割愛する。詳細は、各コンテンツ取得APIのレスポンスを参照。
      required: true
      schema:
        required:
          - contents
        properties:
          contents:
            description: |
              コンテンツを指定する。一括承認の場合は複数のコンテンツを指定する。
            type: array
            items:
              type: object
              required:
                - contentId
                - contentTypeId
                - processId
              properties:
                contentId:
                  type: string
                  description: |
                    下記のコンテンツID

                    - インセンティブコース
                    - お知らせ
                    - クーポン
                    - FAQ
                    - コラム
                    - レシピ
                    - 動くレシピ
                    - ランキング
                    - LCレシピ
                contentTypeId:
                  type: string
                  enum:
                    - "10000"
                    - "20000"
                    - "30000"
                    - "40000"
                    - "50000"
                    - "60000"
                    - "70000"
                    - "80000"
                    - "90000"
                  description: |
                    コンテンツタイプID

                    - "10000": インセンティブコース
                    - "20000": クーポン
                    - "30000": お知らせ
                    - "40000": コラム
                    - "50000": レシピ
                    - "60000": 動くレシピ
                    - "70000": FAQ
                    - "80000": ランキング
                    - "90000": LCレシピ
                processId:
                  type: string
                  enum:
                    - "10"
                    - "20"
                    - "30"
                  description: |
                    処理ID

                    - "10": 新規登録
                    - "20": 改版更新
                    - "30": 公開停止

  tags:
    - Sprint11
    - all
    - Sprint3
  responses:
    200:
      description: |
        コンテンツの受信結果を返す。
      headers:
        $ref: ../definitions/x_server_date.yaml
      schema:
        $ref: '#/definitions/CmsContentsReceive'
    401:
      $ref: ../definitions/error_401.yaml
    403:
      $ref: ../definitions/error_403.yaml
    405:
      $ref: ../definitions/error_405.yaml
    503:
      $ref: ../definitions/error_503.yaml
